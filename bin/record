#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset

if (( $# < 3 )) ; then
    echo "record: not enough arguments" >&2
    exit 1
fi

: ${RECORD_A_SHOW_HOME:="${HOME}/record-a-show"}

STREAMDIR="$1"
STREAMURL="$2"
TOTAL_DURATION="$3"

#------------------------------------------------------------------------------
FFMPEG="/usr/bin/ffmpeg"
SLEEP=5

#------------------------------------------------------------------------------
mkdir -p "${RECORD_A_SHOW_HOME}"
STREAMDIR="$(cd "${RECORD_A_SHOW_HOME}" && realpath "${STREAMDIR}")"

#------------------------------------------------------------------------------
NOW="$(date +%s)"               # 1645902696 (seconds)
DATESTAMP="$(date +'%Y-%m-%d')"      # 2022-02-26
END=$(( NOW + TOTAL_DURATION ))       # 1645910136 (seconds)
INITSLEEP="${SLEEP}"

#------------------------------------------------------------------------------
declare -a CMD
mkdir -p "${STREAMDIR}"
cd "${STREAMDIR}"

EXT="$(ffprobe "${STREAMURL}" |& sed -nE '/^\s*Stream .* Audio: (\S+),.*$/{s//\1/p;q;}')"
: ${EXT:=mp4}          # default. MP4 IS A CONTAINER; CODEC IS COPIED.

while (( NOW < END )) ; do
    FFMPEG_DURATION=$(( END - NOW )) # 7440
    TIMESTAMP="$(date +'%H%M%S')"    # 165800
    FILENAME="${DATESTAMP}-${TIMESTAMP}.${EXT}" # .../2022-02-26-165800.mp4
    CMD=("${FFMPEG}" -y -loglevel warning -i "${STREAMURL}" -t "${FFMPEG_DURATION}" -codec copy "${FILENAME}")
    >&2 echo "+ ${CMD[@]@Q}"
    if "${CMD[@]}" ; then
        break
    fi
    echo "${FFMPEG} failed, exiting with code $?"
    LAST="${NOW}"
    NOW="$(date +%s)"
    if (( NOW - LAST < 5 )) ; then # don't restart too fast
        >&2 echo "sleeping ${SLEEP}; next sleep if restarting too fast = 30"
        sleep "${SLEEP}"; SLEEP=30
        LAST="${NOW}"
        NOW="$(date +%s)"
    elif (( SLEEP > INITSLEEP )) ; then # resume normalcy
        >&2 echo "resume normal sleep 5 next time"
        SLEEP="${INITSLEEP}"
    fi
done
