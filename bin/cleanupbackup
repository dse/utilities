#!/usr/bin/env bash
set -o errexit
set -o pipefail
set -o nounset
shopt -s lastpipe

if (( ! $# )) ; then
    set -- .
fi

main () {
    local dir
    local -a reversed
    reverse "$@"
    for dir in "${reversed[@]}" ; do
        echo "=== ${dir} ==="
        set -o xtrace
        { /usr/bin/find "${dir}" -type l -exec rm {} +           || true ; } | pv -l
        { /usr/bin/find "${dir}" -type f -links +1 -exec rm {} + || true ; } | pv -l
        { /usr/bin/find "${dir}" -depth -type d -exec rmdir {} + || true ; } | pv -l
        set +o xtrace
    done
}

reverse () {
    local i
    for (( i = $# ; i >= 1 ; i -= 1 )) ; do
        reversed+=("${!i}")
    done
}

main "$@"
