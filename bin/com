#!/usr/bin/env perl
use warnings;
use strict;
use Getopt::Long;
use IO::File;
our $dry_run;
our $maxstat = 0;
Getopt::Long::Configure('gnu_getopt');
Getopt::Long::GetOptions('n|dry-run' => \$dry_run,
                         'help|?' => sub { usage(); exit(0); }) or usage();
if (!scalar @ARGV) {
    my $fh = IO::File->new('.comfile', 'r');
    if (!$fh) { usage(); }
    while (<$fh>) {
        s{\R\z}{};
        make($_);
    }
} else {
    if (!$dry_run) {
        my $fh = IO::File->new('.comfile', 'w');
        if ($fh) {
            printf $fh ("%s\n", $_) foreach @ARGV;
        } else {
            printf STDERR ("%s: %s: %s\n", $0, ".comfile", "$!");
        }
    }
    make($_) foreach @ARGV;
    exit($maxstat);
}
sub make {
    my ($filename) = @_;
    my $fh = IO::File->new($filename, 'r');
    if (!$fh) {
        printf STDERR ("%s: %s: %s\n", $0, $filename, "$!");
        $maxstat = 1 if $maxstat < 1;
        return;
    }
    my $dest = $filename;
    $dest =~ s{(?<!^)(?<![/\\])\.[^\./\\]*$}{};
    while (<$fh>) {
        s{\R\z}{};
        last if s{^.*?/\*%\s*}{};
    } continue {
        if (eof($fh)) {
            printf STDERR ("%s: %s: no command\n", $0, $filename);
            $maxstat = 1 if $maxstat < 1;
            return;
        }
    }
    s{\#\#?|\%\%?}{$& eq '%%' ? '%' : $& eq '##' ? '#' : $& eq '%' ? $filename : $dest}ge;
    if ($dry_run) {
        printf("%s\n", $_);
        return;
    }
    printf STDERR ("%s\n", $_);
    if (system("/bin/sh", "-c", $_)) {
        if ($? == -1) {
            printf STDERR ("%s: %s: failed to execute\n", $0, $_);
            $maxstat = 1 if $maxstat < 1;
            return;
        }
        if ((my $signal = $? & 127)) {
            printf STDERR ("%s: %s: killed with signal %d\n", $0, $_, $signal);
            $maxstat = 1 if $maxstat < 1;
            return;
        }
        if ($? & 128) {
            printf STDERR ("%s: %s: core dump\n", $0, $_);
            $maxstat = 1 if $maxstat < 1;
            return;
        }
        if ((my $exit = $? >> 8)) {
            printf STDERR ("%s: %s: exited with value %d\n", $0, $_, $exit);
            $maxstat = $exit if $maxstat < $exit;
            return;
        }
    }
}
sub usage {
    printf STDERR ("usage: %s [-n] [file ...]\n", $0);
    exit(1);
}
