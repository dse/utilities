#!/usr/bin/perl
use warnings;
use strict;
use File::Basename qw(dirname);

cat_apache2_conf(@ARGV);

my $dirname;

sub cat_apache2_conf {
	my @files = @ARGV;
	if (!scalar(@files)) { @files = ("-"); }
	foreach my $file (@files) {
		my $fh;
		if (!open($fh, "<", $file)) {
			warn("$0: $file: not found");
			next;
		}
		if (!defined $dirname) {
			$dirname = dirname($file);
		}
		print("### BEGIN $file ###\n");
		while (<$fh>) {
			chomp();
			next if /^\s*\#/;
			next unless /\S/;
			my $print = 1;
			s/^\s*//;
			if (m{^serverroot\s*(\"[^\"]*\"|\S+)}i) {
				$dirname = $1;
			} elsif (m{^include\s*(\"[^\"]*\"|\S+)}i) {
				my $glob = "$dirname/$1";
				my @glob = glob($glob);
				print("### $_ => glob($glob) => @glob\n");
				cat_apache2_conf(@glob);
				$print = 0;
			}
			print($_, "\n") if $print;
		}
		print("### END $file ###\n");
	}
}

